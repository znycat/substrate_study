"use strict";
var _Combinator_allHasFired, _Combinator_callback, _Combinator_fired, _Combinator_fns, _Combinator_isActive, _Combinator_results, _Combinator_subscriptions;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Combinator = void 0;
const tslib_1 = require("tslib");
const util_1 = require("@polkadot/util");
class Combinator {
    constructor(fns, callback) {
        _Combinator_allHasFired.set(this, false);
        _Combinator_callback.set(this, void 0);
        _Combinator_fired.set(this, []);
        _Combinator_fns.set(this, []);
        _Combinator_isActive.set(this, true);
        _Combinator_results.set(this, []);
        _Combinator_subscriptions.set(this, []);
        tslib_1.__classPrivateFieldSet(this, _Combinator_callback, callback, "f");
        // eslint-disable-next-line @typescript-eslint/require-await
        tslib_1.__classPrivateFieldSet(this, _Combinator_subscriptions, fns.map(async (input, index) => {
            const [fn, ...args] = Array.isArray(input)
                ? input
                : [input];
            tslib_1.__classPrivateFieldGet(this, _Combinator_fired, "f").push(false);
            tslib_1.__classPrivateFieldGet(this, _Combinator_fns, "f").push(fn);
            // Not quite 100% how to have a variable number at the front here
            // eslint-disable-next-line @typescript-eslint/no-unsafe-return,@typescript-eslint/ban-types
            return fn(...args, this._createCallback(index));
        }), "f");
    }
    _allHasFired() {
        tslib_1.__classPrivateFieldSet(this, _Combinator_allHasFired, tslib_1.__classPrivateFieldGet(this, _Combinator_allHasFired, "f") || tslib_1.__classPrivateFieldGet(this, _Combinator_fired, "f").filter((hasFired) => !hasFired).length === 0, "f");
        return tslib_1.__classPrivateFieldGet(this, _Combinator_allHasFired, "f");
    }
    _createCallback(index) {
        return (value) => {
            tslib_1.__classPrivateFieldGet(this, _Combinator_fired, "f")[index] = true;
            tslib_1.__classPrivateFieldGet(this, _Combinator_results, "f")[index] = value;
            this._triggerUpdate();
        };
    }
    _triggerUpdate() {
        if (!tslib_1.__classPrivateFieldGet(this, _Combinator_isActive, "f") || !(0, util_1.isFunction)(tslib_1.__classPrivateFieldGet(this, _Combinator_callback, "f")) || !this._allHasFired()) {
            return;
        }
        try {
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            tslib_1.__classPrivateFieldGet(this, _Combinator_callback, "f").call(this, tslib_1.__classPrivateFieldGet(this, _Combinator_results, "f"));
        }
        catch (error) {
            // swallow, we don't want the handler to trip us up
        }
    }
    unsubscribe() {
        if (!tslib_1.__classPrivateFieldGet(this, _Combinator_isActive, "f")) {
            return;
        }
        tslib_1.__classPrivateFieldSet(this, _Combinator_isActive, false, "f");
        // eslint-disable-next-line @typescript-eslint/no-misused-promises
        tslib_1.__classPrivateFieldGet(this, _Combinator_subscriptions, "f").forEach(async (subscription) => {
            try {
                const unsubscribe = await subscription;
                if ((0, util_1.isFunction)(unsubscribe)) {
                    unsubscribe();
                }
            }
            catch (error) {
                // ignore
            }
        });
    }
}
exports.Combinator = Combinator;
_Combinator_allHasFired = new WeakMap(), _Combinator_callback = new WeakMap(), _Combinator_fired = new WeakMap(), _Combinator_fns = new WeakMap(), _Combinator_isActive = new WeakMap(), _Combinator_results = new WeakMap(), _Combinator_subscriptions = new WeakMap();
